# MiRNA Section -----------------------------------------------------------

MI_first_dataset = reactiveVal()
MI_first_pc = reactiveVal()
MI_first_fc = reactiveVal()
getDTVP <- eventReactive(input$clickMIF,{
  df <- data.frame()
  miF <- "only CAD patients"
  mipa <- switch(miF,"Mature Platelets vs. Reticulated - all data" = "www/rp_vs_mp_diff_mir_counts.CSV", "in MI vs. CAD patients" = "www/disease_diff_mir_counts.CSV" , "only CAD patients"= "www/cad_rp_vs_mp_diff_mir_counts.CSV")
  #print("old path:")
  #print(mipa)
  df <- read.csv2(mipa,header = TRUE, na.strings = "_")
  pval <- input$mpCO
  fc <- input$mfCO
  MI_first_dataset(miF)
  MI_first_pc(pval)
  MI_first_fc(fc)
  df <- df[abs(df$log2FoldChange)>= fc & df$padj < pval, ]
  df <- df[!(is.na(df$baseMean)),]
#  if(input$dtmi_uda == "upregulated"){
#    df<- df[df$log2FoldChange >= fc , ]
#  }else{
#    df<- df[df$log2FoldChange <= -fc , ]
#  }
  names2milinks(df)
})




getVP <- eventReactive(input$clickMIF,{
  df <- data.frame()
  #if(input$miF == "Mature Platelets vs. Reticulated - all data"){
    #
  #  rp_vs_mp <-read.csv2("www/rp_vs_mp_diff_mir_counts.CSV",header = TRUE, na.strings = "_")
  #  df <- rp_vs_mp
  #}else if(input$miF == "in MI vs. CAD patients"){
  #  dis_diff <-read.csv2("www/disease_diff_mir_counts.CSV",header = TRUE, na.strings = "_")
  #  df<- dis_diff
  #}else if(input$miF == "only CAD patients"){
    CAD_rp_vs_mp <- read.csv2("www/cad_rp_vs_mp_diff_mir_counts.CSV",header = TRUE, na.strings = "_")
    #print("old path2")
    #print("www/cad_rp_vs_mp_diff_mir_counts.CSV")
    #print("now replaced path 2")
    df <- CAD_rp_vs_mp
  #}
}
)
getHM <- eventReactive(input$clickMIF,{
  end <- matrix()
  df <- data.frame()
  cdf <- data.frame()
  # if(input$miF == "Mature Platelets vs. Reticulated - all data"){
  #   sig_rp_vs_mp <-read.csv2("www/rp_vs_mp_sign_diff_mir_counts.CSV",header = TRUE, na.strings = "_")
  #   df <- sig_rp_vs_mp
  #   counts <- read.csv2("www/counts_normalized.CSV",header = TRUE, na.strings = "_")
  #   cdf <- counts
  # }else if(input$miF == "in MI vs. CAD patients"){
  #   sig_dis_diff<-read.csv2("www/disease_sign_diff_mir_counts.CSV",header = TRUE, na.strings = "_")
  #   df<- sig_dis_diff
  #   counts_disease <- read.csv2("www/counts_normalized_disease.CSV",header = TRUE, na.strings = "_")
  #   cdf<- counts_disease
  #}else if(input$miF == "only CAD patients"){
    sig_CAD_rp_vs_mp <- read.csv2("www/ccs_rp_vs_mp_diff_mir_counts_noSample6_filtered_pCutoff0.05.CSV",header = TRUE, na.strings = "_") # ccs_rp_vs_mp_diff_mir_counts_noSample6_filtered_pCutoff0.05.CSV bzw das signifikante
    df <- sig_CAD_rp_vs_mp
    #print("df:")
    #View(df)
    #print("new path:")
    #print("www/ccs_rp_vs_mp_diff_mir_counts_noSample6_filtered_pCutoff0.05.CSV")
    counts_disease <- read.csv2("www/counts_normalized_disease.CSV",header = TRUE, na.strings = "_")
    cdf <- counts_disease
    #print("cdf:")
    #View(cdf)
  #}
  neu<- cdf[grep(paste(df[,1],collapse="|"),cdf[,1]),]

  names <-neu[,1]
  neu <-neu[,-1]
  rownames(neu) = make.names(names, unique=TRUE)
  #end<- neu
  merged_annotation <- data.table::fread("www/simulated_sample_names_all.tsv")
  merged_annotation <- as.data.frame(merged_annotation)
  rownames(merged_annotation) <- merged_annotation$original_sample_name
  to_translate <- colnames(neu)
  

  print(to_translate)
  new_names <- merged_annotation[to_translate,]
  #print(to_translate)
  #print(new_names)
  colnames(neu) <- new_names$new_sample_name
  #print("neu:")
  #View(neu)
 # if(input$miF == "only CAD patients"){
    #threshold <- sort(rowVars(counts), decreasing = T)[150]
    #counts = counts[which(rowVars(counts) >= threshold),]
   neu <- neu[ , !(colnames(neu) %in% c("6_MPs","6_RPs"))]
 # }
   #View(neu)

  neu
  
  # counts_disease <- data.matrix(counts_disease)
  #sample_annotation <- colnames(neu)
})

 m2g = reactiveVal("")
 g2g = reactiveVal("")
 minod = reactiveVal("")
 mi_name = reactiveVal("")
 miRNA_up = reactiveVal()
 miRNA_down = reactiveVal()
 miRNA_GO_obj = reactiveVal()
 miRNA_saved_circ = reactiveVal()
 miRNA_saved_ontology = reactiveVal()
 
 
 observe({
   if(!input$miEXP && !input$miSign){
     shinyjs::disable("clickMIF2")
     shinyjs::show("textclickMIF2")
   }else{
     shinyjs::enable("clickMIF2")
     shinyjs::hide("textclickMIF2")
   }
 })
 
 
getMIPaths <- eventReactive(input$clickMIF2,{
  miF2 <- "only CAD patients"
  m2Genes <- get_miRNA_datasets(miF2, input$miDB, input$mTpCO, input$mTfCO, input$miEXP, input$miSign)
  m2Genes_tab <- m2Genes[[input$UDMI]]
  mi_name(miF2)
  sav_circ <- getGeneMat(miF2,input$miAnnot)
  # if(input$UDMI == "upregulated"){
  #   sav_circ <- m2Genes$up_expr
  # }else if(input$UDMI == "downregulated"){
  #   sav_circ <- m2Genes$down_expr
  # }
  # annot <- switch(input$miAnnot, "ENSEMBL ID"= 1, "HGNC symbol" = 11)
  # annot_colname <- colnames(sav_circ)[annot]
  if(input$UDMI == "upregulated"){
    sav_circ <- sav_circ[sav_circ$log2FoldChange > 0,]
  }else if(input$UDMI == "downregulated"){
    sav_circ <- sav_circ[sav_circ$log2FoldChange < 0,]
  }
  miRNA_saved_circ(sav_circ)
  ontology <- switch(input$miOnt,"Biological Process"="BP","Cellular Component"= "CC","Molecular Function" = "MF")
  miRNA_saved_ontology(ontology)
  up <- extract_genes_from_m2g(m2Genes[["upregulated"]],input$miDB,input$miAnnot)
  down <- extract_genes_from_m2g(m2Genes[["downregulated"]],input$miDB,input$miAnnot)
  universe <- getUniverse(miF2,input$miAnnot)
  
  annotation <- switch(input$miAnnot, "ENSEMBL ID"= "ENSEMBL", "HGNC symbol" = "SYMBOL")
  ge2GO <- functional_enrichment(up,down,universe, ontology, annotation)#miRNA_path(input$miOnt, input$miEXP,"G",input$UDMI, input$miDB,input$miF2,input$miSign,"1")
  mir_Nodes <- makeNodes(m2Genes_tab,input$miDB)
  miRNA_up(up)
  miRNA_down(down)
  #print(mir_Nodes)
  #mG <- read.table(m2Genes,header = FALSE)
  m2g(m2Genes_tab)
 # gG <- read.table(ge2GO,quote = "",sep = ",", header = TRUE)
  #mi_tab <- read.table(mir_Nodes, sep = "\t", header = FALSE)
  g2g(ge2GO$tab)
  go_obj <- NULL
  if(input$UDMI== "upregulated"){
    go_obj <- ge2GO$obj_up
  }else if(input$UDMI== "downregulated"){
    go_obj <- ge2GO$obj_down
  }
  miRNA_GO_obj(go_obj)
  #nod(GO_Nodes)
  #edg(GO_Edges)
  minod(mir_Nodes)
  #finalpath <- m2Genes
  #mG <- read.delim(m2Genes, header=FALSE, na.strings = NA,comment.char = "",quote = "\"", sep = "\t",dec = ".")
  #if(input$miDB == "miRDB"){ 
  #  colnames(mG)=c("Target Gene (Ref-Seq ID)", "Target Gene (Ensembl ID)", "miRNA", "prediction score")
  #}else if(input$miDB == "miRTarBase"){
  #  colnames(mG)=c("miRNA","miRTarBase ID", "Species (mRNA)", "Target Gene", "Target Gene (Entrez ID)", "Species (Target Gene)","Experiments","Support Type","References (PMID)")
  #}
  #end <- 
  m2Genes_tab
})
output$MIDT <- renderDataTable(getMIPaths(),escape = FALSE,extensions = c("Buttons","Scroller"), options = list(lengthMenu = c(10,15,20), pageLength = 10, scrollX = TRUE,width = 500, dom = 'Bfrtip',bPaginate = FALSE,
                                                                           buttons =list(list(
                                                                             extend = 'collection',
                                                                             buttons = c('csv', 'excel'),
                                                                             text = 'Download'
                                                                           ))))
output$DTMI <- renderDataTable(
  {df <- getDTVP()
  if(input$dtmi_uda == "upregulated"){
    df<- df[df$log2FoldChange >= MI_first_fc() , ]
  }else{
    df<- df[df$log2FoldChange <= -MI_first_fc(), ]
  }
  df
    }
  ,escape = FALSE, extensions = c("Buttons","Scroller"),options = list(lengthMenu = c(10, 15, 20), pageLength = 5,scrollX = TRUE,width = 200, dom = 'Bfrtip',
                                                                                                             buttons =list(list(
                                                                                                               extend = 'collection',
                                                                                                               buttons = c('csv', 'excel'),
                                                                                                               text = 'Download'
                                                                                                             )))
)
saved_VPMI = reactiveVal()
output$VPMI <- renderPlot({
  tab <- getVP()
 if(!is.null(tab)){ 
   tab <- tab[!(is.na(tab$padj)),]
   tab <- tab %>% mutate(padj = str_replace(padj,"E", "e"))
   tab <- tab %>% mutate(padj = str_replace_all(padj,",", "."))
   
   tab[,7] = as.numeric(tab[,7])
   #annot <- gene_name_column()
   #order 
   upreg_genes <- tab[tab$log2FoldChange > as.numeric(input$mfCO) & tab$padj < as.numeric(input$mpCO), ]
   upreg_genes <- upreg_genes[upreg_genes[,1]!= "",]
   top10_upreg_genes <- upreg_genes[order(upreg_genes$padj, decreasing = FALSE),1] [1:10]
   
   downreg_genes <- tab[tab$log2FoldChange < -as.numeric(input$mfCO) & tab$padj < as.numeric(input$mpCO), ]
   downreg_genes <- downreg_genes[downreg_genes[,1]!= "",]
   top10_downreg_genes <- downreg_genes[order(downreg_genes$padj, decreasing = FALSE), 1][1:10]
   
   VP = paste0("Volcanoplot: ", MI_first_dataset())
   VP_subtitel = paste0("p-value cutoff: ",MI_first_pc(),", log2FoldChange: ",MI_first_fc())
   p <- myVolcanoPlot(tab,
                data_type = "miRNA",
                pCutoff = as.numeric(input$mpCO),
                FCcutoff = as.numeric(input$mfCO),
                xlim = c(-6, 6),
                lab_selection = c(top10_upreg_genes,top10_downreg_genes),
                symbol_type = colnames(getVP())[1] , titel = VP, subtitel = VP_subtitel)

  saved_VPMI(p)
  p}
})
saved_HMMI = reactiveVal()
output$HMMI <- renderPlot({
  counts <- getHM()
  cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
  #View(counts)
  if(!is.null(counts)){
    #if(input$miF == "only CAD patients"){
      #threshold <- sort(rowVars(counts), decreasing = T)[150]
      #counts = counts[which(rowVars(counts) >= threshold),]
      #counts <- counts[ , !(colnames(counts) %in% c("6_MPs","6_RPs"))]
      acs <- c("25_MPs","25_RPs","26_MPs","26_RPs","27_MPs","27_RPs","28_MPs","28_RPs")
      counts <- counts[ , !(colnames(counts) %in% acs)]
      # counts <- counts[, c("8_MPs","8_RPs","11_RPs","12_MPs","13_MPs","4_MPs","5_MPs","1_MPs","9_MPs","2_MPs","7_MPs","10_MPs","11_MPs","14_MPs","10_RPs",
      #                      "19_RPs","9_RPs","1_RPs","5_RPs","15_RPs","14_RPs","12_RPs","13_RPs","7_RPs","16_MPs","16_RPs","20_MPs","20_RPs","3_MPs",
      #                      "3_RPs","19_MPs","18_MPs","18_RPs","17_MPs","17_RPs","15_MPs","2_RPs","4_RPs")]
      
   # }
  dbo_file <- data.table::fread("www/simulated_sample_names_all.tsv")
  #View(dbo_file)
  dbo <- data.frame("names" = dbo_file$new_sample_name, "Condition" = dbo_file$condition, "Platelet type" = dbo_file$platelet )
  rownames(dbo) = dbo$names
  dbo <- dbo[,-1]
  pl_names = c(cbbPalette[1],cbbPalette[4])#c(RPs = cbbPalette[1], MPs = cbbPalette[4])
  names(pl_names) = c("RP", "MP")
  d_names = c("lightblue","orange","darkgreen")
  names(d_names) = c("healthy","ACS", "CCS")
  #ann_col = list(`Platelet type` = pl_names,Condition = d_names)
  # colnames(dbo) = c("Disease", "Platelet type")
  # pl_names = c("red","blue")
  # names(pl_names) = c("RP", "MP")
  # d_names = c("orange","darkgreen")
  # names(d_names) = c("MI", "stable CAD")
  # 
  HM_title= paste0("Heatmap: ", MI_first_dataset())#",, p-value cutoff: ",MI_first_pc(),", log2FoldChange: ",MI_first_fc()
  #VP_subtitel = paste0()
  ann_col = list(`Platelet type` = pl_names,Disease = d_names)
  #View(dbo)
  print(counts)
  p <- pheatmap(counts,
                color = colorRampPalette(c("blue", "red"))(50),
                annotation_colors = ann_col,
                annotation_col = dbo,#dbo %>% select('Platelet type' = dbo$`Platelet type`, 'Disease' = dbo$Disease),
                show_rownames = FALSE, show_colnames = TRUE, scale="row", main = HM_title)
  saved_HMMI(p)
  graphics.off()
  p
  }
  #saved_HMMI()
  
}
)

saved_MAMI = reactiveVal()
output$MAMI <- renderPlot({
  tab <- getVP()
  if(!is.null(tab)){
    tab <- tab[!(is.na(tab$padj)),]
    tab <- tab %>% mutate(padj = str_replace(padj,"E", "e"))
    tab <- tab %>% mutate(padj = str_replace_all(padj,",", "."))
    
    tab[,7] = as.numeric(tab[,7])
    annot <- gene_name_column()
    MA_title = paste0("MA plot: ", MI_first_dataset())
    p <- myMAplot_lim(tab, fdr = as.numeric(input$mpCO), fc = as.numeric(input$mfCO), ylim = c(-4, 4), MA_title) #fdr ... + make ylim scalable
    saved_MAMI(p)
    p
  }
  
})

#myPCAplot(vst(dds_ccs), intgroup = "RPs_MPs") + 
#geom_label_repel(aes(label=colnames(dds_ccs)), size = 2, show.legend = FALSE)
#
saved_PCAMI = reactiveVal()
output$PCAMI <- renderPlot({
  tab <- getHM()
  #View(tab)
  if(!is.null(tab)){
    dis_metatab <- metatab
    dis_metatab <-dis_metatab[row.names(dis_metatab) %in% colnames(tab),]

    p <- pca(tab, metadata = dis_metatab, removeVar = 0.1)
    p_title = paste0("Biplot: ", MI_first_dataset())
    
    b<- biplot(p,colby = 'platelet', colkey = c('MP' = 'blue', 'RP' = 'red', "0" = 'black'),
               shape = 'condition', shapekey = c('CCS'=15, 'ACS'=17, 'healthy' = 15 ),#'Grade 3'=8
               hline = 0, vline = c(-25, 0, 25),
               legendPosition = 'right', legendLabSize = 16, legendIconSize = 8.0,
               title = p_title,
               
    )
    saved_PCAMI(b)
    b
  }
  
})

saved_ExpMI = reactiveVal()
output$ExpMI <- renderPlot({
  d <- getHM()
  if(!is.null(d)){
    p_title = paste0("Expression Analysis: ", MI_first_dataset())
    p <- myCountAnalysisPlot(as.data.frame(d), "miRNA", p_title)#fdr ... + make ylim scalable 
    saved_ExpMI(p)
    p
  }
})

# miRNA Targets & GO ------------------------------------------------------

saved_DTMIT = reactiveVal()
output$DTMIT <- renderDataTable({
  g2g <- as.data.table(g2g())#[,c(1,2,3,4,5,6)]
  g2g <- g2g[g2g$significantly_expressed == input$UDMI & g2g$p.adjust <= 0.05, ]
  g2g <- filterGO(g2g,input$gos_of_interest_MI)
  
  g2g <- g2g[, -"significantly_expressed"]

  
  g2g$Genes <- str_replace_all(g2g$Genes,"/", "; ")
  datatable(
    cbind(' ' = '&oplus;', g2g), escape = -2,
    extensions = c("Buttons","Scroller"),
    options = list(
      columnDefs = list(
        list(visible = FALSE, targets = c(8)),
        list(orderable = FALSE, className = 'details-control', targets = 1)
      ),
      lengthMenu = c(5, 10, 15),
      width = 500,
      scrollX = TRUE, dom = 'Bfrtip',
      bPaginate = FALSE,
      buttons =list(list(
        extend = 'collection',
        buttons = c('csv', 'excel'),
        text = 'Download'
      ))
    ),
    callback = JS("
  table.column(1).nodes().to$().css({cursor: 'pointer'});
  var format = function(d) {
    return '<div style=\"background-color:#eee; padding: .5em;\">  ' +
            'Genes: ' + d[8] + '</div>';
  };
  table.on('click', 'td.details-control', function() {
    var td = $(this), row = table.row(td.closest('tr'));
    if (row.child.isShown()) {
      row.child.hide();
      td.html('&oplus;');
    } else {
      row.child(format(row.data())).show();
      td.html('&CircleMinus;');
    }
  });"
    ))
  #  ,escape = FALSE, options = list(lengthMenu = c(10, 15, 20), pageLength = 15)
}


)
saved_MIGOnet = reactiveVal()
output$MIGOnet <- renderPlot({
  obj <- miRNA_GO_obj()
  if(!is.null(obj)){
    term_enriched <- any(obj@result[["p.adjust"]]<= 0.05)
    if(term_enriched){
      saved_MIGOnet(obj)
      goplot(obj)
    }else{
      validate(
        need(term_enriched == TRUE, "0 enriched terms found (p-value < 0.05)")
      )
    }
  
  }
})


output$MIpG<- renderPlotly({
  getMIPaths()
  tabi <- g2g()
  if(!is.null(tabi)){
  tabi <- tabi[tabi$significantly_expressed == input$UDMI & tabi$p.adjust <= 0.05, ]
  tabi <- filterGO(tabi,input$gos_of_interest_MI)
  tabi$percentage <- tabi$'%' *100
  #print(tabi$percentage)
  tabi <- as.data.table(tabi)
  tabi$percentage <- as.numeric(tabi$percentage)
  tabi <- tabi[order(tabi$percentage,decreasing = FALSE),]
  # form <- list(categoryorder = "array",
  #             categoryarray = tabi$id,
  #             title = "category")
  fig <- plot_ly(tabi, x = ~Category, y = ~percentage, type = 'bar', name = 'percentage of differentially expressed genes in category',text = ~Term,marker = list(color = '#ba3131'))
  fig <- fig %>% layout(title = "Percentage of differentially expressed target genes in GO categories")
  fig
  }

   # barmode = 'group'
  #)
  # fig
  
})

output$MIpFE <-renderPlotly({
  # n <- fthreshold()
  getMIPaths()
  testtab <- g2g()#f_foldenrich(saved_GO(),n)
  if(!is.null(testtab)){
  testtab <- testtab[testtab$significantly_expressed == input$UDMI & testtab$p.adjust <= 0.05, ]
  testtab <- filterGO(testtab,input$gos_of_interest_MI)
  testtab <- testtab[order(testtab$FDR, decreasing = FALSE),]
  testtab <- testtab %>% mutate(FDR = -log10(FDR))
  form <- list(categoryorder = "array",
               categoryarray = testtab$Category,
               title = "category")
  fig2 <- plot_ly(testtab, x =~FDR, y = ~Category, type = 'bar', name = 'enrichment FDR in categories',text = ~Term, orientation = 'h' ,marker = list(color = '#ba3131'))
  #fig <- fig %>% add_trace(y = ~numInCat, name = 'number of genes in category', marker = list(color = '#ffe5ea'))
  fig2 <- fig2 %>% layout(title = "enrichment FDR in categories", xaxis = list(title = "enrichment FDR"),
                          yaxis = form,
                          margin = list(b = 100))
  fig2
  }
  # fig2
  
})

output$MIGO_perc_term <- renderPlotly({
  getMIPaths()
  gotab <- g2g()
  if(!is.null(gotab)){
  gotab <- gotab[gotab$significantly_expressed == input$UDMI & gotab$p.adjust <= 0.05, ]
  gotab <- filterGO(gotab,input$gos_of_interest_MI)
  gotab$percentage <- gotab$'%' *100
  #print(tabi$percentage)
  gotab <- as.data.table(gotab)
  gotab$percentage <- as.numeric(gotab$percentage)
  form <- list(categoryorder = "array",
               categoryarray = gotab$percentage,
               title = "Percentage")
  fig2 <- plot_ly(gotab, x =~percentage, y = ~p.adjust, name = 'Scatterplot: percentage of genes in a GO Term and its adjusted p-value',mode = "markers", size = ~percentage, text = ~Term)
  fig2 <- fig2 %>% layout(title = "Scatterplot: percentage of target genes in a GO Term and its adjusted p-value", yaxis = list(title = "adjusted p-value"),
                          xaxis = form,
                          margin = list(b = 100))
  # fig2
  fig2
}
})
output$MIGO_padj_logFC <- renderPlotly({
  getMIPaths()
  gotab <- g2g()
  if(!is.null(gotab)){
  gotab <- gotab[gotab$significantly_expressed == input$UDMI & gotab$p.adjust <= 0.05, ]
  gotab <- filterGO(gotab,input$gos_of_interest_MI)
  
  circ_data <- make_circ_data(gotab,miRNA_saved_circ(),miRNA_saved_ontology())
  
  #gotab$percentage <- gotab$'%' *100
  #print(tabi$percentage)
  gotab <- as.data.table(circ_data)
  #gotab$percentage <- as.numeric(gotab$percentage)
  form <- list(categoryorder = "array",
               categoryarray = gotab$logFC,
               title = "logFC")
  fig2 <- plot_ly(gotab, x =~logFC, y = ~adj_pval, name = ~term,mode = "markers",color = ~term,customdata = ~term,size = ~logFC, text = ~genes, hovertemplate = paste('<br>gene: %{text}<br>', '<br>term: %{customdata}<br>'))
  fig2 <- fig2 %>% layout(title = "Scatterplot: logFC of target genes in a GO Term and its adjusted p-value", yaxis = list(title = "adjusted p-value"),
                          xaxis = form,
                          margin = list(b = 100))
   fig2
}
})



output$MIGOC <- renderPlotly({
  getMIPaths()
  gotab <- g2g()
  if(!is.null(gotab)){
  gotab <- gotab[gotab$significantly_expressed == input$UDMI & gotab$p.adjust <= 0.05, ]
  gotab <- filterGO(gotab,input$gos_of_interest_MI)
  circ_data <- make_circ_data(gotab,miRNA_saved_circ(),miRNA_saved_ontology())
  chosen_terms <- circ_data[1:10,3] #top 10 highest logFC
  filtered_tab <- circ_data[circ_data$term %in% chosen_terms,]
  p<- plot_ly(filtered_tab,x = ~term, y = ~logFC, type = "violin",text = ~genes,color= ~regulation,hovertemplate = paste('%{x}', '<br>gene: %{text}<br>')) %>%
    add_markers(size = 5)
  p <- p %>% layout(title = "GO categories with the 10 highest DE target genes")
  p
  }
})



ColourScale <- 'd3.scaleOrdinal()
            .domain(["mir", "Gene", "u", "d"])
           .range(["#0000ff","#a0b6fe","#008000","#d01212"]);'

output$MInet <- renderForceNetwork({
  #minet()
  t <- minod()
  if(!is.null(t)){
  #datasetname <- mi_name()
  #miud_liste<-getDIFmi(datasetname,input$mdTPM,input$mdfc,input$mdpc)
  u <- miRNA_up()
  d <- miRNA_down()
  ensemb <- data.frame(t[,1],t[,3])
  hgnc <-data.frame(t[,1],t[,2])
  colnames(ensemb) <- c("from","to")
  colnames(hgnc) <- c("from", "to")
  if(input$miAnnot=="ENSEMBL ID"){
    edges <- ensemb
  }else{
    edges <- hgnc
  }
  nodes <- data.frame(name = unique(c(edges$from, edges$to)), stringsAsFactors = FALSE)
  nodes$id <- 0:(nrow(nodes) - 1)
  nodes$type <- "Gene"
  nodes$type[startsWith(nodes$name,"hsa-")] <- "mir"
  nodes$type[nodes[,1] %in% u] <- "u"
  nodes$type[nodes[,1] %in% d] <- "d"
  miedges <- edges %>%
    left_join(nodes, by = c("from" = "name")) %>%
    select(-from) %>%
    rename(from = id) %>%
    left_join(nodes, by = c("to" = "name")) %>%
    select(-to) %>%
    rename(to = id)
  forceNetwork(Links = miedges, Nodes = nodes,
               Source = "from", Target = "to",
               #Value = "", 
               NodeID = "name", Group = "type",opacity = 0.9,fontSize = 11, zoom = TRUE,colourScale = JS(ColourScale))}
})

# output$MIGOC <- renderPlotly({
#   gotab <- saved_GO()
#   gotab <- gotab[gotab$significantly_expressed == input$UDA, ]
#   gotab <- filterGO(gotab,input$gos_of_interest)
#   circ_data <- make_circ_data(gotab,saved_circ_mat(),saved_ontology())
#   chosen_terms <- circ_data[1:10,3] #top 10 highest logFC
#   filtered_tab <- circ_data[circ_data$term %in% chosen_terms,]
#   p<- plot_ly(filtered_tab,x = ~term, y = ~logFC, type = "violin",text = ~genes,color= ~regulation,hovertemplate = paste('%{x}', '<br>gene: %{text}<br>')) %>%
#     add_markers(size = 5)
#   p
# })

output$MIGOp <- renderPlotly({
  getMIPaths()
  gotab <- g2g()
  if(!is.null(gotab)){
  gotab <- gotab[gotab$significantly_expressed == input$UDMI & gotab$p.adjust <= 0.05, ]
  gotab <- filterGO(gotab,input$gos_of_interest_MI)
  #circ_data <- make_circ_data(gotab,saved_circ_mat(),saved_ontology())
  #circ_data_sorted <- circ_data[,-4] %>% arrange(adj_pval)
  gotab <- gotab%>% arrange(p.adjust)
  circ_end <- gotab[1:10,]
  form <- list(categoryorder = "array",
               categoryarray = circ_end$Category,
               title = "Category")
  fig2 <- plot_ly(circ_end, x =~Category, y = ~p.adjust, type = 'bar', name = 'Top 10 categories with lowest adjusted p-values',text = ~Term, marker = list(color = '#ba3131'))
  fig2 <- fig2 %>% layout(title = "Top 10 categories with lowest adjusted p-values", yaxis = list(title = "adjusted p-value"),
                          xaxis = form,
                          margin = list(b = 100))
   fig2
  }
})

miRNA_fp <- paste0(getwd(),"/new/")#"/www/miRNA/new/"
get_miRNA_datasets <- function(dataset, db, pC, fC, experimentally, significant){
  zipped <- unzip(paste0(getwd(),"/www/miRNA/new.zip"), list=FALSE,  exdir = ".",unzip = "internal")
  print(zipped)
  data_name <- switch(dataset, "Mature Platelets vs. Reticulated - all data" = "rp_mp","in diseased patients" = "dis","only CAD patients" = "ccs"  )
  database_name <- switch(db,"miRTarBase"= "tar", "miRDB" = "rdb")
  miRNA_targets_filepath <- paste0(miRNA_fp,data_name,"_",database_name,"_db.tsv")
  miRNA_expr_filepath <- switch(dataset,"Mature Platelets vs. Reticulated - all data" = "www/rp_vs_mp_diff_mir_counts.CSV", "in MI vs. CAD patients" = "www/disease_diff_mir_counts.CSV", "only CAD patients" = "www/ccs_rp_vs_mp_diff_mir_counts_noSample6_filtered_pCutoff0.05.CSV")
  miRNA_targets <- data.table::fread(miRNA_targets_filepath)
  miRNA_expr <- read.csv2(miRNA_expr_filepath,header = TRUE, na.strings = "_")
  target_colnames <- switch(db, "miRDB" = c("Target Gene (Ref-Seq ID)", "Target Gene (HGNC Symbol)", "miRNA", "prediction score","Target Gene (ENSEMBL ID)"),"miRTarBase" = c("miRNA","miRTarBase ID", "Species (mRNA)", "Target Gene", "Target Gene (Entrez ID)", "Species (Target Gene)","Experiments","Support Type","References (PMID)","exp_type", "Target Gene (Ensembl ID)"))
  colnames(miRNA_targets)= target_colnames
  if(experimentally && db == "miRTarBase"){
    miRNA_targets <- miRNA_targets[miRNA_targets$exp_type == "experimentally_retrieved",]
  }
  if(significant){
    miRNA_expr_filtered <- miRNA_expr[!is.na(miRNA_expr$padj) & miRNA_expr$padj <= pC & abs(miRNA_expr$log2FoldChange) >= fC,1]
    miRNA_targets <- miRNA_targets[miRNA_targets$miRNA %in% miRNA_expr_filtered,]
  }
  #up_miRNA <- miRNA_expr[miRNA_expr$log2FoldChange > 0 ,]
  #down_miRNA <- miRNA_expr[miRNA_expr$log2FoldChange < 0 ,]
  up_miRNA_expr <- miRNA_expr[miRNA_expr$log2FoldChange > 0 ,1]
  down_miRNA_expr <- miRNA_expr[miRNA_expr$log2FoldChange < 0 ,1]
  #universe <- getUniverse()
  up_miRNA_targets <- miRNA_targets[miRNA_targets$miRNA %in% up_miRNA_expr,]
  down_miRNA_targets <- miRNA_targets[miRNA_targets$miRNA %in% down_miRNA_expr,]
  
  
  return(list("upregulated" = up_miRNA_targets,"downregulated" = down_miRNA_targets))
}


makeNodes <- function(miRNATargets, db){
  nodes <- NULL
  if(db == "miRTarBase"){
    nodes <- miRNATargets[,c(1,4,11)]
  }else if(db == "miRDB"){
    nodes <- miRNATargets[,c(3,2,5)]
  }
  colnames(nodes) = c("miRNA", "hgnc_symbol", "ensembl_id")
  # nodes$regulation <- "no regulation"
  # if(annot == "ENSEMBL ID"){
  #     nodes$regulation[nodes$ensembl_id %in% up] <- "upregulated"
  #     nodes$regulation[nodes$ensembl_id %in% down] <- "downregulated"
  # }else{
  #     nodes$regulation[nodes$hgnc_symbol %in% up] <- "upregulated"
  #     nodes$regulation[nodes$hgnc_symbol %in% down] <- "downregulated"
  # }
  return(nodes)
}

library(purrr)
extract_genes_from_m2g <- function(miRNA_Targets, db, annot_type){
  extracted <- NULL
  if(db == "miRTarBase"){
    annotate <- switch(annot_type, "ENSEMBL ID" = 11,"HGNC symbol" = 4)
    extracted <- miRNA_Targets[,..annotate]
  }else if(db == "miRDB"){
    annotate <- switch(annot_type, "ENSEMBL ID" = 5,"HGNC symbol" = 2)
    extracted <- miRNA_Targets[,..annotate]
  }
  extracted <- unlist(extracted)
  extracted_new <- extracted[!is.na(extracted)] 
  return(extracted_new)
}

getUniverse <- function(input_datapath,annot_type){
  miRNA_expr_filepath <- switch(input_datapath,"Mature Platelets vs. Reticulated - all data" = "www/all_healthy_TPM-0-1.CSV", "in MI vs. CAD patients" = "www/all_diseased_TPM-0-1_disease-phenotype-all.CSV", "only CAD patients" = "www/all_diseased_TPM-0-2_phenotype-disease-stable-CAD.CSV")
  miRNA2 <-  switch(input_datapath,"Mature Platelets vs. Reticulated - all data" = "www/all_diseased_TPM-0-1_phenotype-disease-all.CSV", "in MI vs. CAD patients" = "", "only CAD patients" = "") # TODO: hae was ist hier los
  extra_list <- c()
  gncol <- switch(annot_type, "ENSEMBL ID"= 1, "HGNC symbol" = 11)
  if(miRNA2 != ""){
    matr2<- read.csv2(miRNA2)
    extra_list <- matr2[,gncol]
  }
  matr <- read.csv2(miRNA_expr_filepath)
  genes <- matr[,gncol]
  all_genes <- c(genes,extra_list)
  return(all_genes)
}

getGeneMat <- function(input_datapath,annot_type){
  miRNA_expr_filepath <- switch(input_datapath,"Mature Platelets vs. Reticulated - all data" = "www/all_healthy_TPM-0-1.CSV", "in MI vs. CAD patients" = "www/all_diseased_TPM-0-1_disease-phenotype-all.CSV", "only CAD patients" = "www/all_diseased_TPM-0-2_phenotype-disease-stable-CAD.CSV")
  miRNA2 <-  switch(input_datapath,"Mature Platelets vs. Reticulated - all data" = "www/all_diseased_TPM-0-1_phenotype-disease-all.CSV", "in MI vs. CAD patients" = "", "only CAD patients" = "")
  extra_df <- NULL
  gncol <- switch(annot_type, "ENSEMBL ID"= 1, "HGNC symbol" = 11)
  if(miRNA2 != ""){
    matr2<- read.csv2(miRNA2)
    annot_colname <- colnames(matr2)[gncol]
    extra_df <- matr2[,c(annot_colname,"log2FoldChange")]
  }
  matr <- read.csv2(miRNA_expr_filepath)
  annot_colname <- colnames(matr)[gncol]
  genes <- matr[,c(annot_colname,"log2FoldChange")]
  all_genes <- rbind(genes,extra_df)
  return(all_genes)
}


# Buttons -----------------------------------------------------------------













